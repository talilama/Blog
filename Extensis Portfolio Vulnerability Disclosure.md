# Extensis Portfolio Vulnerability Disclosure
Oct 11, 2024 12:53:26 PM

### Authors ####
Michael Rand identified these vulnerabilities and published the CVEs and provided the technical details for the blog post
Talis Ozols assisted with exploitation, disclosure, and writing the blog post

## Summary ##

During an external penetration test, White Oak Security discovered an instance of the Extensis Portfolio software which was deployed publicly on the internet with default administrative credentials. Using black-box web \[…\]

During an external penetration test, White Oak Security discovered an instance of the [Extensis Portfolio](https://www.extensis.com/portfolio) software which was deployed publicly on the internet with default administrative credentials. Using black-box web application testing techniques, White Oak Security was able to achieve remote code execution via an unrestricted file upload. This was a newly discovered (“zero day”) vulnerability in the software, making Extensis Portfolio Server a subject for further research. White Oak Security applied its comprehensive [white box application penetration testing program](https://www.whiteoaksecurity.com/services/application-security/) to recreate the environment locally and began analyzing the source code for additional vulnerabilities.

As part of this research, **White Oak Security discovered five (5) High-Risk flaws within the Extensis Portfolio application** (Versions 4.0 and Version 3.6.3):

*   Main & Admin Portals: Authentication Bypass – Hard-Coded Credentials (CVE-2022-24255)
*   Main Portal: Authenticated Unrestricted File Upload Resulting in Remote Code Execution (CVE-2022-24251)
*   Main Portal: Authenticated Unrestricted File Upload + Path Traversal Resulting in Remote Code Execution (CVE-2022-24252)
*   Admin Portal: Authenticated Archive Zip-Slip Path Traversal Resulting in Remote Code Execution (CVE-2022-24254)
*   Admin Portal: Authenticated Unrestricted File Upload Resulting in Remote Code Execution (CVE-2022-24253)

For a temporary fix of the authentication bypass, [please check this blog post.](https://www.whiteoaksecurity.com/blog/java-editing-bytecode/)

Extensis Portfolio Overview
---------------------------

Extensis Portfolio is a digital asset management platform used by content teams to organize their digital media into various content catalogs and provides a hosting platform for digital assets. Extensis Portfolio is made up of three (3) core applications: a user-facing content management application (referred to as “main”), an administrative portal, and a content hosting application. Typically, only the main portal application is exposed on the internet. However, several administrative portals have been found exposed to the internet as well. A majority of the application features deal with the management of multimedia files, including the ability to upload and download images and videos.  

Unfortunately, Extensis was not receptive to the disclosure of these vulnerabilities and has not made a patch available at this time. As such, White Oak Security is compelled to disclose these issues publicly. For additional information around our disclosure timeline, please refer to the end of this post.

Extensis Portfolio Vulnerability Analysis
-----------------------------------------

### Main & Admin Portals: Authentication Bypass – Hard-Coded Credentials

#### CVE-2022-24255

One of the first findings White Oak Security discovered was an instance of Hard-Coded Credentials within the main and admin portal applications’ authentication flow. These credentials are a ‘backdoor’ password into the applications, gaining the permissions of an administrative user. A malicious threat actor can use these capabilities to exploit the remainder of the issues described in this post.

First, an administrator creates or updates their account with a non-default password. In the example below, the administrative user will have a unique password set. 

![White Oak Security provides the first step in the recent disclosure vulnerability of Extensis Portfolio, this shows the login page where an administrator creates or updates their account with a non-default password. In the example below, the administrative user will have a unique password set. ](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/bo_KLAZn70qvis8pGRJ_-ot8rnqoZ6aBuA2mY9c4Cag6aHhA0LWZfuAlU4XfUKZyP2yiiyMvj3TXsgy6mYr_rbC9QTF1uZjnf5N64FxIQ7Sn3djidmf0pW-1qBiaKOtgb_6vwiUo.png?width=417&height=351&name=bo_KLAZn70qvis8pGRJ_-ot8rnqoZ6aBuA2mY9c4Cag6aHhA0LWZfuAlU4XfUKZyP2yiiyMvj3TXsgy6mYr_rbC9QTF1uZjnf5N64FxIQ7Sn3djidmf0pW-1qBiaKOtgb_6vwiUo.png)

Next, a user attempts to authenticate into the main portal application as the administrative user with an invalid password. The application correctly denies the authentication since the password is incorrect.

![Next, this capture shows a user attempts to authenticate into the main Portfolio Server application as the administrative user with an invalid password. The application correctly denies the authentication since the password is incorrect.](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/_XBdTS63Gjd8NSZfAe-yROhQFxNsUP0mzgEdmewN1yEpqRW0W5R7PUzgFF0kbQ4RV19bRgysV_QiO0a-KJzat6mYClsljpwN5Mxfvza_9NWPBenCexKDpBzU4J-EzS_m6FPmstbC.png?width=299&height=447&name=_XBdTS63Gjd8NSZfAe-yROhQFxNsUP0mzgEdmewN1yEpqRW0W5R7PUzgFF0kbQ4RV19bRgysV_QiO0a-KJzat6mYClsljpwN5Mxfvza_9NWPBenCexKDpBzU4J-EzS_m6FPmstbC.png)

Then, the user authenticates into the same application with the hard-coded backdoor password. (Note: This password is not included in this disclosure at this time as a patch for this issue has not been made available by Extensis.)

![Then, White Oak Security's pentesters show the user authenticates into the same application with the hard-coded backdoor password. (Note: This password is not included in this disclosure at this time as a patch for this issue has not been made available by Extensis.)](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/-5ohftKINidxN9VaoJ8v5FKyUOwK5DR6GGdqoiLUJ-rfK7TivWMS_3or2x5Jn85PWvN_K-SEPhlKCbIAANipTzUV7D5U3onznXf-Yym3Uh5jUa7ubCkd4B7ASHB0fTUqgv8amHWy.png?width=320&height=489&name=-5ohftKINidxN9VaoJ8v5FKyUOwK5DR6GGdqoiLUJ-rfK7TivWMS_3or2x5Jn85PWvN_K-SEPhlKCbIAANipTzUV7D5U3onznXf-Yym3Uh5jUa7ubCkd4B7ASHB0fTUqgv8amHWy.png)

The application successfully processes this authentication request and the user authenticates as the administrative user. 

![White Oak Security's pentesters are in! The application successfully processes this authentication request and the user authenticates as the administrative user. ](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/LBnp4usM_GJZlPfcvLJdL4dIXW0m991s44rDacDUfEoXLmxI6rVnNO41pRb7fQzJR43PgbI3av-sqWxbZgsjgeutuA5H6Tr7QHyVhc6mT-x41T73BsVFRICakZtlSb2vNC7l85dp.png)

Note, this authentication bypass also works for the admin portal as the authentication flow implements the same code path.

![This screenshot shows this authentication bypass also works for the administrative portal as the authentication flow follows the same path.](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/VltGhiA6ZmwZV6LkZ3fJ64oeL5Wfy6TXv94LPBmtC8KXDYYhgWDTvzurm6uc0oj24jT6SdKYl3D42PHEL61z460MtgR_E_IMvlgYtKMNHnXqOCmhF_bxrCjfdPcTSxZnKGWtErN3.png?width=397&height=396&name=VltGhiA6ZmwZV6LkZ3fJ64oeL5Wfy6TXv94LPBmtC8KXDYYhgWDTvzurm6uc0oj24jT6SdKYl3D42PHEL61z460MtgR_E_IMvlgYtKMNHnXqOCmhF_bxrCjfdPcTSxZnKGWtErN3.png)

Using the hard-coded password, a user can gain access to a visually limited administrative view into the application. However, this user’s administrative session does have full permissions over the application.

![in the Catalogs part of Portfolio, White Oak Security Using the hard-coded password, a user can gain access to a visually limited administrative view into the application. However, this user’s administrative session does have full permissions over the application.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/OX176ex5CQrkVPqrRaDrzoGR30pgklFBqB-D-woJ5L-UdZnYbydzzfAwBQ3dtaVXLRjNharMwPckhPNCQ7XJCiQF9RWI7QQq6l5SXDoqOHEiufot9gPPlXV0Q3wosC2b3woUheYY.png)

Using the session generated with the hard-coded credentials, a malicious user can craft a request to the /user/ API and modify the current administrator’s password to a value of their choosing. Note: This password is hashed client side and the value can easily be generated by performing a sample login request to get the generated value.

![Viewing the HMTL code this time, White Oak Security uses the session generated with the hard-coded credentials, you can craft a request to the /user/ API and modify the current administrator’s password to a value of your choosing.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/fANWWTmzaUBk7_2ceevDfIQ7yFYIsP95viJ83Yi3BvCVgkM54PsOjumXqj4AcySeMPHh_Q5th0_Uu5q1I1o6an2eZhMR9K_UvA1vN5xVTw3IMQ7-3CdDUNnHcKj3MdNlVVq-gVUZ.png)

Successful password update for the administrator account.

![This shows the Successful password update for the administrator account by White Oak Security.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/niZeUryDw0PCsc_uaHWNLKYxVmYT6B2mWKiLVOoh42ltQgghLjf_g0MDLnZARJpJLERk5SvWqqAWXHmnQWgMl3lmodpq14j2KGia5JQI9oAy2khpuQ72O5DQjcxiNhzfvU4iFF3u.png)

Authenticating into the administrator portal with these new credentials allows for full UI access into the other administrative settings granting full control over the application. This password change also applies to the main portal application, granting full administrative control over that application as well.

![Shows the full page of the portfolio running and all the access, Authenticating into the administrator portal with these new credentials allows for full UI access into the other administrative settings granting full control over the application. This password change also applies to the main portal application, granting full administrative control over that application as well - screen grab by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/ge6fqKNtRPrmTCVerMJhVzg8sIRAK63XPQJw73q2I4KttgFjELKbYVUZGNybafvSyeFsAAJO8BQiM2Ef9oNilsXwyoU5Wg9Rt9pPNel2nFDS620JtN8t-AIvNwMEwAchSE59kuGe.png)

This vulnerability exists because of hard-coded credentials implemented in

```
C:\Program Files (x86)\Extensis\Portfolio Server\applications\tomcat\servers\main\webapps\ROOT\WEB-INF\lib\portfolio-classes.jar.
```


### Main Portal: Authenticated Unrestricted File Upload Resulting In Remote Code Execution

#### CVE-2022-24251

White Oak Security discovered a chain of events during typical file uploads within the main portal application that can result in remote code execution. First, the application does not properly allow list and perform content inspection on the files that are uploaded to the catalog. By default, any file can be uploaded to the portal application. A malicious threat actor can upload a JSP file that contains a simple web shell to achieve code execution against the underlying web server.

![White Oak Security discovered a chain of events during typical file uploads within the main portal application that can result in remote code execution. First, the application does not properly whitelist and perform content inspection on the files that are uploaded to the catalog. By default, any file can be uploaded to the portal application. A malicious threat actor can upload a JSP file that contains a simple web shell to achieve code execution against the underlying web server. This screenshot shows that we have access to upload assets.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/HzE3gBk7RuwdEvJwFofZ0z8MC0AhPb0sdfmeNgUp8mmfqebIHcaJ_WuVd4uThS1AU9QzAC6ijmrz_Ch9FQTvLVPte8f2ihXXQ19jmIWDY5LkVPQiiSbFviPt4DV8ib85RIaY7DO7.png)

Next, the application provides built-in functionality to “export” uploaded files to any location on the local system. It is unclear why this is a feature of the application, but at the very least, the application should be allow listing the specific directories that a file could be exported to on the local system. 

![White Oak Security selects the "copy/move/export selection" option - Next, the application provides built-in functionality to “export” uploaded files to any location on the local system. It is unclear why this is a feature of the application, but at the very least, the application should be whitelisting the specific directories that a file could be exported to on the local system. ](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/-38hD8lk0qMXclQ1_FlW-drSZK_Ax1Qlo9SvvVGdQNQpPaH_sgH3kaEtzaVY3kTRiMAbP_DPMfoik63L01xxC8aBvMlsCBysbOxzLEhxj9paODqY5vOCdne_fMXelvAEJGodrvoS.png)

Therefore, it becomes trivial to export a malicious JSP file into the web root of the application which results in code execution.

![As White Oak Security exports, it goes into the webapps > root folder](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/743tK6WN2nUrW7JeLFV6ASoYmYDb9FtTH60wV7PZgwDXeR0hVXkfrJMrtRDtpYOwP0gDdKAEiu7hpWXGIMcZ-MAmYJjXkeDKWI29cQAv4v0n6z5pKdZPAAUAhwAlV6ksp3ibfqLt.png)

The file is successfully copied to the web root:

![This screenshot shows that the file was successfully copied to the web root by White Oak's pentesters](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/kzg_0pw_m1bIcg5tDaiiV10iM5SX1ykfccdKMMm3aZoEmFZqEb0Hch5YaOWghyFmakKqqooYQqTo-NGEQTO72296MpCaT8fLKZokjzntVocS5zyORhw0PosPukR3ickNwgWk542Y.png)

The malicious JSP file can be used to execute operating system commands, such as “whoami”, demonstrating code execution as SYSTEM:

![White Oak Security then proves that malicious JSP file can be used to execute operating system commands, such as “whoami”, demonstrating code execution as SYSTEM..](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/XPhRoDvd9raF6HUnr_uCzLmiKJQKkHafmyhuecHN8Fa_1SiFFVIIP3Y9vjtjnnMuHIHUiZvy0BmELAsVRnBENiWgUX__vp2E-Pcn-s8c2eQ7RlfgHtBwFeg31rh2hydnOo6z01mD.png?width=779&height=215&name=XPhRoDvd9raF6HUnr_uCzLmiKJQKkHafmyhuecHN8Fa_1SiFFVIIP3Y9vjtjnnMuHIHUiZvy0BmELAsVRnBENiWgUX__vp2E-Pcn-s8c2eQ7RlfgHtBwFeg31rh2hydnOo6z01mD.png)

### Main Portal: Authenticated Unrestricted File Upload + Path Traversal Resulting in Remote Code Execution

#### CVE-2022-24252

White Oak Security identified a second instance of an unrestricted file uploads within the Main Portal application:

Extensis Portfolio provides [functionality for custom scripts to be executed server-side](https://doc.extensis.com/api/portfolio-scripting/script-interface/script-interface/index.html) (1) using the Nashorn scripting engine. While the use of the Nashorn scripting engine can be secure, a default implementation is often configured to load arbitrary classes (and consequently, execute remote code) [if no class allow list protections are in place (2)](https://www.roguesecurity.in/2019/07/27/nashorn-remote-code-execution/).

These scripts must be placed within the “custom-scripts” directory in the application root to be executed. However, the “custom-scripts” directory is not created by default in a standard Extensis Portfolio installation. 

Therefore, the following vulnerabilities must be exploited within Extensis Portfolio in order for remote code execution to occur:

*   Unrestricted Directory Creation
*   Lack Of Class Allow List Within The Nashorn Scripting Engine
*   Unrestricted File Upload + Path Traversal

### Unrestricted Directory Creation

The “custom-scripts” directory does not exist in a default Portfolio installation. This folder would be created by a developer within the “data/” directory.

![White Oak Security shows the “custom-scripts” directory does not exist in a default Portfolio installation. This folder must be created by a developer within the “data/” directory.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/6CAX9c6SaWZD26tOCj76FYa7qtQmrSCoGTuy6w_nQKGz7thY0Koi5ojAMv6sH9sEPedli0rtAQpLzTwxsdKlInodRj4SeLvfHxsI2hMKPcLZN2BpVkX5i1jWnrfQPekNs2PbveJw.png)

The good news for a malicious actor is that the Portfolio application exposes an API (/identity/verify-folder) which will create any arbitrary local directory specified on the server. The “create” URL parameter is what enables this directory creation within the source code.

![The good news for a malicious actor is that the Portfolio application exposes an API (/identity/verify-folder) which will create any arbitrary local directory specified on the server. The “create” URL parameter is what allows this directory creation.](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/M538a-4dIogRAK0HjSlNhUigif-LiGJM2kFFowD5Tbp9mJfCvN-sLBb7mKfNx2SypTh6Csgzba6ZP1pem0Rf3w_Phwe1YU9zyVySshPY0KjLBqp0sUn8JitD7Blq49UttkkC0L3C.png?width=962&height=509&name=M538a-4dIogRAK0HjSlNhUigif-LiGJM2kFFowD5Tbp9mJfCvN-sLBb7mKfNx2SypTh6Csgzba6ZP1pem0Rf3w_Phwe1YU9zyVySshPY0KjLBqp0sUn8JitD7Blq49UttkkC0L3C.png)

![The good news for a malicious actor is that the Portfolio application exposes an API (/identity/verify-folder) which will create any arbitrary local directory specified on the server. The “create” URL parameter is what allows this directory creation. Part 2 by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/3rPWsCeeNkSNxjw6WBDbj_v5X6O57wGkrZ87pjVjRRYRinEe4SXBSvbTnHIHol8Ndv-SS_b0XQyJsQNQ6ZghvhUuA0IJNg9ZJAGAjRiLQ_pi3mvLEkWCm2aKSztfX61bf2DwAhtX.png)

![White Oak shows the custom-scripts folder file - Any script placed within this directory will be automatically executed when a user authenticates into the Portfolio application. This is the default behavior of scripts placed within this directory, as these scripts are intended to be used to provide extra functionality for the web application. The scripts are automatically executed based on default interactions with the application (and subsequent API requests) as a user interacts with the Portfolio application UI.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/GaZHpFMOhUxDxtrOShTCKouFqbEHLM6sE8yoGdAF-Y0Knik8G2JD3SuA2fa74H-cTrNBeMVTKpTLay8dkdSngrH2G8jnLgfh5twX3d6vvEHVxKnKm3xS6QjfuPne9h6-CghI-NYP.png)

It’s important to note for exploitation purposes, any script placed within this directory will be automatically executed when a user authenticates into the Portfolio application. This is the default behavior of scripts placed within this directory, as these scripts are intended to be used to provide extra functionality for the web application. The scripts are automatically executed based on default interactions with the application (and subsequent API requests) as a user interacts with the Portfolio application UI.

### Lack Of Class Allow Listing Within The Nashorn Scripting Engine

White Oak Security crafted a custom script that will be executed by the scripting engine. This script uses reflection to load an instance of the Java Runtime, which allows arbitrary commands to be executed. After analyzing the source code and configuration files, no class allow listing was in place within the Extensis Portfolio application. Any arbitrary class can be loaded within these scripts. The following script, when executed, will establish a session on a remote victim host using a simple reverse shell. This script could add a web shell, create user accounts, or do any other malicious actions against the underlying server to give an attacker full control over the application.

```
function getProperties() {
	return {
	  triggerPoints: [ 'onCataloged', 'onMetadataUpdated', 'onGalleryChanged', 'onJobInitialize', 'onJobEachAsset', 'onJobFinalize' ],
	  scheduleInfo: { cronExpression: '0 0 0/4 * * ?', eventId: 'my-scheduled-script' },
	  displayName: 'Test Script',
	  permissions: [ 'canAdministerCatalog' ],
	  hasDownloadResult: false,
	  processCurrentOrganizer: true,
	  processNoAssets: false
	};
}

function onCataloged(catalogId, assetId) {
	portfolio.log('onCataloged called for catalog ' + catalogId + ', asset ' + assetId);
}

function onGalleryChanged(catalogId, galleryId, wereItemsAdded, assetQuery, assetCount) {
	portfolio.log('onGalleryChanged called for catalog ' + catalogId + ', gallery ' + galleryId + ', ' + assetCount + ' assets ' + (wereItemsAdded ? 'added' : 'removed'));
}

function onMetadataUpdated(catalogId, assetId, changes) {
	portfolio.log('onMetadataUpdated called for catalog ' + catalogId + ', asset ' + assetId);
}

function onSchedule() {
	portfolio.log('scheduled script running');
}

function onJobInitialize(data) {
	portfolio.log('onJobInitialize called for catalog ' + data.catalogId);
}

function onJobEachAsset(data) {
	portfolio.log('onJobEachAsset called for catalog ' + data.catalogId + ', asset ' + data.itemState.assetId);
}

function onJobFinalize(data) {
	portfolio.log('onJobFinalize called for catalog ' + data.catalogId);
}

function getIndexOfMethod(methodArray, methodName){
	var count = 0;for each (var method in methodArray){if(method.toString() == methodName){return count;}count++;}return null;
}
 
// Payload goes here
var command = "<payload here>";
 
// Create an instance of class 'Class'
var obj = ''['class'];
 
// Get the list of all the methods
var methods = obj.getClass().getMethods();
 
// Find the index of 'forName()' method
var forNameString = "public static java.lang.Class java.lang.Class.forName(java.lang.String) throws java.lang.ClassNotFoundException";
var forNameMethodIndex = getIndexOfMethod(methods, forNameString);
 
// Find the index of 'getRuntime()' method
var runTimeMethods = methods[forNameMethodIndex].invoke(null, 'java.lang.Runtime').getMethods();
var getRuntimeString = "public static java.lang.Runtime java.lang.Runtime.getRuntime()";
var getRunTimeMethodIndex = getIndexOfMethod(runTimeMethods, getRuntimeString);
 
// Execute the command
runTimeMethods[getRunTimeMethodIndex].invoke(null).exec(command);
```


### Unrestricted File Upload + Path Traversal

Next, White Oak Security needed an unrestricted file upload vulnerability to place this script within the “custom-scripts” directory. An unrestricted file upload vulnerability was discovered within the _FileTransferServlet_. A tainted file name containing relative paths will place this file on an arbitrary location on a disk. In this case, the “custom-scripts” directory was targeted.

![White Oak Security needed an unrestricted file upload vulnerability to place this file within the “custom-scripts” directory. An unrestricted file upload vulnerability was discovered within the FileTransferServlet. A tainted file name containing relative paths will place this file on an arbitrary location on a disk. In our case, the “custom-scripts” directory was targeted.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/ZcQGn-XsBO16cnwYLTwVlpw6KuRbjuoBeC3pswm70dHaEeBOkON9b6ZId3_wmx03Y06JSJlGG77CsK7GMyNmn8OfML47IMUUxrHy-mAvrZyDtvpCeAEd0m-vibys2_oL5-ifa5QV.png)

Successful file upload response to the targeted location.

![Successful file upload response to an arbitrary location by White Oak Security's pentesters](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/aiDIFmmwLed9b4rRAFr8AoVFb6QjqNM9LPUxUwVVfMyXP7VRx8_ZO5ZATnCiZhebPTXHiSoXCr1GAvrDJzrkyQo11bi0tDyaC96wpAgMrY5Nwr-SmNRjprR0cVY6tm1onH63XCH2.png)

However, when navigating to the “custom-scripts” directory, the file was not there. White Oak Security observed that this file upload does not actually persist on disk. The file is only created **temporarily** and then **deleted** from the file system. White Oak Security monitored the custom-scripts directory and observed that the “aaaa.js” file was created and then immediately deleted during the upload request.

![when navigating to the “custom-scripts” directory, the file was not there. White Oak Security observed that this file upload does not actually end up persistent on disk. The file is only created temporarily and then deleted from the file system. White Oak Security monitored the custom-scripts directory and observed that the “aaaa.js” file was created and then immediately deleted.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/wfvxkyy_rU2UoIBtrIwHKlgB_H7ZNGXUgjMp9lgQx1zfqZsPgAp6WiEHke13vKlOvMKd4WdDRGH2UDtMalAR6Y0Cx8nO2ohA3naexaBptlaXLJEFO2kSetLhHKUtVdhBhx_JwWNK.png)

White Oak Security analyzed the source code for this file upload flow and found that the function is vulnerable to a _[time of check to time of use race condition](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use)_ (3). The application creates a temporary file from the uploaded file content, moves this file to the arbitrary location in the filename, and saves the file content to the database to store metadata used for image previews. Once the database save occurs, the file is subsequently deleted from the disk. If files are uploaded over and over within a short period of time, due to a lack of file locks, the web server will not be able to delete the file before a user can interact with the web server. **Therefore, a period of time exists between the creation and deletion of the file where a user can actually execute the script.** In this case, the script contains malicious code which could be used to gain command execution against the underlying server. In this proof of concept, White Oak Security will execute a reverse shell which gains remote system access against the web server.

White Oak Security used Burp Suite Intruder to execute upload requests sequentially over a short period of time with no delay between requests. An alternative method to exploitation could be to keep a single request open rather than sending the “close” connection header.

![White Oak Security used Burp Suite Intruder to execute upload requests sequentially over a short period of time with no delay between requests. An alternative method to exploitation could be to keep a single request open rather than sending the “close” connection header.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/C8V9Y87kA8uV7E5v3YDxRBOBFhyC7zCsQGG2NBxUhh8EbQPvTjWWZagGRyaXrV2in8MrxG4dC7s5PjeGNt_3miZoo58S3E5AyivkieD5rhv7H3eJAC07mTl7HmhdNrQ7k0oDkp7l.png)

Observing the local file system, it was observed that several scripts are successfully uploaded to the custom-scripts directory before being deleted since the application does not lock the files before deletion.

![Observing the local file system, we can see that several scripts are actually uploaded to the custom-scripts directory before being deleted since the application does not lock the files before deletion.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/_AgTgq8dCFeri_8iew-DI66vCvIV4L5GMLqAqxpPud_XzjBxhyhQFHqMN2nbMxF08ZVWAjweV8rmdB0WexIocOyz6lJAavHNOA1WSDywtaUTKxJ05W61BoFIm4li3Y2hGL9jyj7u.png)

At the same time as the first intruder upload requests, White Oak Security used Burp Suite Intruder to constantly poll the web server while the file upload was occurring. Since the custom scripts will actually execute on nearly every API request and the scripts do not have to be accessed directly, an example API request below will trigger the command execution if the script exists within the “custom-scripts” directory when this API request is called.  

![At the same time as the first intruder upload requests, White Oak Security used Burp Suite Intruder to constantly poll the web server while the file upload was occurring. Since the custom scripts will actually execute on nearly every API request and the scripts do not have to be queried directly, an example API request below will trigger the command execution if the script exists within the “custom-scripts” directory when this API is called.  ](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/QtnxbQJtdM_9brRkO9ZWQ_2QK6WEzjcnbEokr_0XlnqT_6QHM7aPAOp6baj_yuu7EMoev4lyOBfOrl7FZdFhz1ScvVTIL_LdgrsdNnGrE3kzbFmIWViZsS0xoRz2iRQhCp9rVdO1.png)

White Oak Security monitored the attacker host for incoming connections and observed the results of the command execution. Multiple sessions were opened as the race condition attack was successful over multiple attack iterations. White Oak Security was able to retrieve the current working directory of a given reverse shell using the ‘pwd’ command as an example to demonstrate remote code execution. Since the application (rather than the file) is the executing process, the reverse shell is persistent even after the temporary files are deleted after the race condition requests are complete.

![White Oak Security monitored the attacker host for incoming connections and observed the results of the command execution. Multiple sessions were opened as the race condition attack was successful during multiple attack iterations. White Oak Security was able to retrieve the current working directory of a given reverse shell using the ‘pwd’ command as an example demonstrating remote code execution. Since the application spawns PowerShell (or any command) in a new session, these remote connections are persistent even after the file is deleted. ](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/I6KSxhSWdgvtVa8M2LYQG0KvOs0HTsahcNrtNc97m1Dg7l0l5z6_Z3QWRYW1pFcpQfy-9Fw7sU1qv7EHw8Ah0PcAzYcep2vVXlMiUeBf7vFH47bN-dgjr_CGUSRuNG_fBGhm4n_j.png)

### Admin Portal: Authenticated Archive Zip-Slip Path Traversal Resulting in Remote Code Execution

#### CVE-2022-24254

White Oak Security also analyzed the Admin Portal application and identified two more vulnerabilities which result in remote code execution. While the Admin Portal is not typically supposed to be exposed on the internet, instances of the admin portal can be found on the internet at the time of this blog’s creation. An instance of the Zip-Slip vulnerability was discovered within the flow for restoring the application from an archive backup.

[Zip Slip](https://snyk.io/research/zip-slip-vulnerability) (4) is a form of directory traversal that can be exploited by extracting files from an archive to an arbitrary location. The premise of the directory traversal vulnerability is that an attacker can extract a file to parts of the file system outside of the target folder in which the extracted files should reside.

First, White Oak Security created a zip archive with the expected Portfolio Server backup archive structure. A sample archive can be generated from a backup request within the admin portal, which can be used as a template for this exploit. The database content (dbdump.out) is not necessarily required, but several metadata checks from the file content do occur before the zip-slip vulnerability is triggered (such as an inspection of default data from the .data/preferences file); therefore maintaining the expected directory and file structure is highly recommended.

![White Oak Security created a zip file with the following structure. The default folders are necessary to ensure the backup is extracted properly and can be generated from a sample backup zip archive within the portal. The database content (dbdump.out) is not necessarily required, but several metadata checks do occur before the zip-slip vulnerability (e.g., taking default data from the .data/preferences file) and so maintaining the expected directory and file structure is recommended.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/SwyEvviM2_VidnCVTYJwDCV3XpN77vckw9nlxxD36JzflP7v-49gCnqWenpe--dvY7HyUcv0c7xqL_kWkDJVqZ2Gh3p8UfY39lHjCmztGJ6mz2N2JYFaNRdYudPFtfImStZ6LICO.png)

Next, White Oak Security used a python script, [evilarc](https://github.com/WhiteOakSecurity/CVE-2018-19859/blob/master/evilarc_whiteoak.py) (5), to create a malicious zip file containing a JSP web shell. The web shell’s archive path was modified using the tool to include path traversal characters. Since the portfolio admin application is vulnerable to zip-slip, the web shell will be placed within the public web directory when the archive is extracted.

![](https://blog.cyberadvisors.com/hs-fs/hubfs/Imported_Blog_Media/eJ15vQvbWBRGYjd2T0qTtC2y5IBE4f54d7rC3G8aao18IZ61dCgTsv-hxXOY0gkvIfAV55Ki_kgAVX5xDBDPgLuyqjiJLDe1d6lpwqgUZim_a_kHtH9DwzGDdKtyKUKTHFrx2GMR.png?height=204&name=eJ15vQvbWBRGYjd2T0qTtC2y5IBE4f54d7rC3G8aao18IZ61dCgTsv-hxXOY0gkvIfAV55Ki_kgAVX5xDBDPgLuyqjiJLDe1d6lpwqgUZim_a_kHtH9DwzGDdKtyKUKTHFrx2GMR.png)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

White Oak Security navigated to the Backup functionality within the admin portal and chose ‘Restore From Backup’.

![White Oak Security navigated to the Backup functionality within the Administrative portal and chose ‘Restore From Backup’.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/H2eq8xWwo6qdenWxe6rnUEbiv7wF-ON2eCVrlUV9r5NFKcZ1xLpNoNH-tOzlhIqadX1mEYDYY8jcTq_9swVyE0jvCO3JpfBIJOEU2GSKhiuPzRtWvu8YPbTWnlthUvVZ9AiDPl71.png)

The backup archive module is built to restore from a local backup on disk. However, the request can be captured using an HTTP proxy tool, such as Burp Suite, and the path can be modified to point to a remote web server location. An alternative exploitation path could use any of the unrestricted file upload vulnerabilities within this post.

![The backup archival module is built to restore from a local backup on disk. However, the request can be captured using an HTTP proxy tool, such as Burp Suite, and the path can be modified to point to a remote web server location is shown in this HTML screen grab by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/4JQRwIT8auVGwCuJv4sXm5PHqZ4w-J1Ju0437IOgEwfcv5-h9F6kBp9CCT9Mr4qfq4jdw3NDtDmzIZY02PpVourfPAFV98ubAGAegbdofw5CPQDpNjYBa00vRSkEp_kJjA860tBs.png)

The application will begin the backup process. The archive backup will most likely fail if the backup archive has been tampered with or the exact database is not restored.

![This Restore Failed page shows there was an issue with trying to restore the data by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/VzbGj4y15mLf6Sh6cVvR84E7fSH6KKTzuO-GifJqNsMq6KfZzOuAPRnFr6Y9VtudoVdbb1tnvMXtDvCFU89dp_2NSGWRifZiA9tJJSbSvw7NqVYX_Z0tAjowuoYEbP66ti2vwJmd.png)

However, even if the job fails, the embedded malicious file will have been successfully extracted to the destination path. In this case, the web root of the admin portal application successfully contains the web shell. 

![However, White Oak has the embedded malicious file will have been successfully extracted to the destination path. In our case, the web root of the admin portal application. ](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/SEYcJ2NhBm011sKVbGTKRoPXwKzfEV2lA8Nm8V6IdivILEKvRlAmWpSTIHX_A8v1Do-dii3YVtjwqFalZSXOzurab1OrQBLB3O4IlJH_XCqAo-5x7mXh_fpNtBq9kFQ2Pv0RkZO5.png)

The web shell executed successfully on the admin portal application.

![The web shell executed successfully on the admin portal application by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/gHMYl0anuGnu9k1ztIMCnjPuHr_TAYvLS0vq1PSHjhHGwSv_JnfXMMWOwTjrmEjGlA7LXhovZ9bQiJg2cVVSvm9XZ5_eNJRqnUQqQkGHXCB1eNl4DUQl7sBnjCs0mE9428Hw6LML.png)

### Admin poRtal: Authenticated Unrestricted File Upload + Path Traversal Resulting in Remote Code Execution

#### CVE-2022-24253

White Oak Security discovered an unrestricted file upload vulnerability within the AdminFileTransferServlet “brandingupload” functionality. An arbitrary file can be uploaded with any given filename (such as a malicious JSP containing a web shell). This filename can include path traversal characters to upload the file to a specific directory. In this example, the web shell was uploaded to the web root.

![White Oak Security discovered an unrestricted file upload vulnerability within the AdminFileTransferServlet “brandingupload” functionality. An arbitrary file can be uploaded with any given filename (such as a malicious JSP containing a web shell). This filename can include path traversal characters to upload the file to an arbitrary directory. In this example, the web shell was uploaded to the web root.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/c_2XFFPtJB00au8tk16bnCEN5CcqOkFhwlpLaw8RyKjK0uT5rcIlu7dQ1QZ5UxG0EjZRbL-ZeWuzlPsJh1xoBdboxJb5CLdHEVdW_JngoAbcvfSjn7AvaXV78S-DXYfKprVrs5Rc.png)

The file was successfully created within the target location inside of the web root.

![The file was successfully written to the target location inside of the web root folder by White Oak Security](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/odYb1ek_AkakaPDakBNGen_tY2qbWMaB0rn6EP5vjIwgL4_lNZ_z9DI2-gQAA7n0W2c1bYPGW6T79wPCcmYNykPE4ArxT6cDuz7XzTPVEHJw_ka4yoMUcAHO7Isdy7GVaWZFznr6.png)

The web shell executed successfully on the admin portal application.

![The web shell executed successfully on the admin portal application by White Oak Security.](https://blog.cyberadvisors.com/hubfs/Imported_Blog_Media/PHa8Tj8_ga-Xc-PJjTBeLmDLy_SXwkM0_6YD1wyb8g8z9VnURDVaYw3qISP_tTmXu6aTIVNRCc8X-5SD8grquUOgj9gf0pYgGZuY_ru87UHQfEo_01xuemjuwyrreCXvIH2g9R0U.png)

Unofficial Mitigation for Authentication Bypass
-----------------------------------------------

White Oak Security recommends a temporary mitigation to the hard-coded administrative credentials. An organization can perform assembly byte patching of the Extensis jar file that handles authentication to change or remove the hard-coded credentials. Check this [blog about editing Bytecode.](https://www.whiteoaksecurity.com/blog/java-editing-bytecode/)

This hardcoded password can be found in extensis.portfolio.server.manager.ManagerUtils.authenticateUser() in the following jar file:

```
C:\Program Files (x86)\Extensis\Portfolio Server\applications\tomcat\servers\main\webapps\ROOT\WEB-INF\lib\portfolio-classes.jar
```


Additionally, White Oak Security recommends ensuring the default administrator password has been changed on your Portfolio Server install. 

Extensis Suggested Mitigation for Unrestricted File Upload
----------------------------------------------------------

Extensis provided White Oak Security with the following instructions for mitigating the initial unrestricted file upload:

_This can likely be resolved via the following Portfolio Admin configuration settings_ :  

*   **Cataloging only known filetypes** ( _recommended_ ) :
    *   Portfolio Admin > Catalogs >  \[ _Catalog Name_ \] > Ingest > File Types > **Catalog Only**.
*   **Excluding specific filetypes** :
    *   Portfolio Admin > Catalogs >  \[ _Catalog Name_ \] > Ingest > File and Folder Exclusions > **Ends with “.jsp”**

White Oak Security has not tested these mitigations or attempted bypasses at the time of writing these blog posts and cannot comment on the effectiveness of these controls.

Disclosure Timeline
-------------------

White Oak Security followed [responsible disclosure guidelines](https://www.whiteoaksecurity.com/disclosure-policy/) by giving Extensis significant time to remediate these High-Risk issues. White Oak Security repeatedly asked Extensis for a timeline for expected remediation. However, after 164 days since initial contact regarding the vulnerabilities, Extensis informed White Oak Security that these security issues had not been prioritized and Extensis did not have an expected date for remediation. 

As of 2/17/22, Extensis has not provided White Oak Security any indication that these vulnerabilities will be fixed. White Oak Security has disclosed these issues according to our vulnerability disclosure policy. 

As it took White Oak Security over a month just to initiate contact with Extensis, we highly recommend Extensis create a specific security disclosure email address or contact form to facilitate and expedite future communication. 

**8/16/21:** Attempted to contact Extensis via official Contact Form – No Response

**8/25/21:** Attempted to contact Extensis via official Contact Form – No Response

**8/26/21:** Contacted Extensis via Sales form. A sales member informed White Oak Security they will provide White Oak with a security contact. Security contact was not provided.

**9/17/21:** Follow up with the sales team about security contact. – Sales did not respond.

**9/27/21:** Contacted Extensis via Twitter DM for security contact – Extensis Twitter account informed White Oak that we cannot contact Extensis without an active contractual service agreement.

**9/29/21:** Leveraged a client contact to open a service ticket on behalf of White Oak Security – White Oak successfully disclosed details of an initial Unrestricted file upload vulnerability and Extensis confirmed receipt of those disclosure details.

**9/29/21:** Extensis informs White Oak Security that we need to test this vulnerability on the latest version of Portfolio Server (4.0.0), as several fixes have been made since the version we originally tested (3.6.3).  White Oak confirms this issue is likely still present in version 4.0.0 and asks if this specific issue was remediated in the update, as the vulnerability was not described in the Patch Notes.

**10/22/21:** White Oak re-confirms for Extensis that the vulnerability was valid in 4.0.0 – Extensis does not respond. White Oak informs Extensis several other vulnerabilities were discovered and asks for their preferred file transfer method for sharing these details securely.

**11/2/21:** White Oak Security disclosed an additional four (4) vulnerabilities to Extensis – Extensis provides potential mitigation steps for unrestricted file upload.

**12/6/21:** White Oak Security asks for a status update on the remediation timeline – Extensis acknowledges vulnerabilities but declines to provide an ETA.

**1/3/21:** White Oak Security asks for a status update on the remediation timeline – Extensis acknowledges vulnerabilities but declines to provide an ETA.

**1/27/21:** White Oak Security asks for a status update on remediation timeline – Extensis acknowledges vulnerabilities and states that no timeline has been created for these issues, no security patch has been scheduled, and that the vulnerabilities have not been prioritized within their development queue.  

**2/17/22**: White Oak Security publicly discloses the issues per our vulnerability disclosure policy.

### Sources:

1.  [https://doc.extensis.com/api/portfolio-scripting/script-interface/script-interface/index.html](https://doc.extensis.com/api/portfolio-scripting/script-interface/script-interface/index.html) – Extensis Script API
2.  [https://www.roguesecurity.in/2019/07/27/nashorn-remote-code-execution/](https://www.roguesecurity.in/2019/07/27/nashorn-remote-code-execution/) – Nashorn Remote Code Execution example
3.  [https://en.wikipedia.org/wiki/Time-of-check\_to\_time-of-use](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use) – Time of Check to Time of Use Software Bug
4.  [https://snyk.io/research/zip-slip-vulnerability](https://snyk.io/research/zip-slip-vulnerability) – Zip-Slip Vulnerability Overview
5.  [https://github.com/](https://github.com/ptoomey3/evilarc)
[ptoomey3](https://github.com/ptoomey3/evilarc)
[/evilarc](https://github.com/ptoomey3/evilarc) – Zip-Slip archive generation tool
